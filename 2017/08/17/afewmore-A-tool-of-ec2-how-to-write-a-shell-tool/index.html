<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>afewmore | Ankai Liang's Blog</title><noscript>Please enable JavaScript to view the site</noscript><link rel="icon" href="/img/pwa/favicon.png"><!-- index.css--><link rel="stylesheet" href="/css/index.css?v=1.7.8"><!-- inject head--><link rel="stylesheet" href="https://cdn2.codesign.qq.com/icons/7pOrz0WXB5ZWJPX/latest/iconfont.css"><!-- aplayer--><!-- swiper--><!-- Open Graph--><meta name="description" content="A tool of ec2--how to write a shell tool"><!-- pwa--><script>(win => {
        win.saveToLocal = {
            set: function setWithExpiry(key, value, ttl) {
                if (ttl === 0)
                    return
                const now = new Date()
                const expiryDay = ttl * 86400000
                const item = {
                    value: value,
                    expiry: now.getTime() + expiryDay,
                }
                localStorage.setItem(key, JSON.stringify(item))
            },

            get: function getWithExpiry(key) {
                const itemStr = localStorage.getItem(key)

                if (!itemStr) {
                    return undefined
                }
                const item = JSON.parse(itemStr)
                const now = new Date()

                if (now.getTime() > item.expiry) {
                    localStorage.removeItem(key)
                    return undefined
                }
                return item.value
            }
        }

        const DarkModeStatus = localStorage.getItem('theme')
        if (DarkModeStatus !== null) {
            if (DarkModeStatus === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark')
            } else {
                document.documentElement.setAttribute('data-theme', 'light')
            }
        }

        const asideStatus = saveToLocal.get('aside-status')
        if (asideStatus !== undefined) {
            if (asideStatus === 'hide') {
                document.documentElement.classList.add('hide-aside')
            } else {
                document.documentElement.classList.remove('hide-aside')
            }
        }

        win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
            const link = document.createElement('link')
            link.rel = 'stylesheet'
            link.href = url
            if (id) link.id = id
            link.onerror = reject
            link.onload = link.onreadystatechange = function () {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                link.onload = link.onreadystatechange = null
                resolve()
            }
            document.head.appendChild(link)
        })

        win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
            const script = document.createElement('script')
            script.src = url
            script.async = true
            script.onerror = reject
            script.onload = script.onreadystatechange = function () {
                const loadState = this.readyState
                if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
                script.onload = script.onreadystatechange = null
                resolve()
            }

            Object.keys(attr).forEach(key => {
                script.setAttribute(key, attr[key])
            })

            document.head.appendChild(script)
        })
    }
)(window)

console.log(
    "%c Program: Hexo %c Theme: Solitude %c Version: v1.7.8",
    "border-radius:5px 0 0 5px;padding: 5px 10px;color:white;background:#ff3842;",
    "padding: 5px 10px;color:white;background:#3e9f50;",
    "border-radius:0 5px 5px 0;padding: 5px 10px;background:#0084ff;color:white;"
);</script><!-- global head--><script>const GLOBAL_CONFIG = {
    root: '/',
    algolia: undefined,
    localsearch: undefined,
    runtime: '2023-04-20 00:00:00',
    lazyload: {
        enable: false,
        error: '/img/error_load.png'
    },
    copyright: false,
    highlight: {
        enable: true,
        limit: 200,
        expand: true,
        copy: true,
        syntax: 'highlight.js'
    },
    randomlink: false,
    lang: {"theme":{"dark":"dark","light":"light"},"copy":{"success":"Copied","error":"Copied failed"},"backtop":"Back to top","time":{"day":" days ago","hour":" hours ago","just":"just","min":" minutes ago","month":" months ago"},"f12":"Developer mode is turned on, please follow the GPL."},
    aside: {
        sayhello: {
            morning: 'The plan for the day lies in the morning.',
            noon: 'Only when you've eaten your fill do you have the energy to work.',
            afternoon: 'Concentrate your energy and overcome difficulties.',
            night: 'Don't tire yourself out too much; early sleep is healthier.',
            goodnight: 'Have a good sleep to ensure abundant energy.',
        },
        sayhello2: [],
    },
    covercolor: {
        enable: false
    },
    comment: {"avatar":"https://cravatar.cn","url":"https://waline-comment-b9nz6bbxt-ankailiangs-projects.vercel.app/","commentBarrage":true,"owo":{"body":".wl-emoji-popup","item":".wl-tab-wrapper button"}},
    lightbox: 'null',
    post_ai: {"key":null,"talk":null,"randomPost":false}
};</script><meta name="generator" content="Hexo 7.1.1"></head><body id="body"><!-- universe--><canvas id="universe"></canvas><!-- loading--><!-- console--><div id="console"><div class="close-btn" onclick="sco.hideConsole()"><i class="solitude st-close-fill"></i></div><div class="button-group"><div class="console-btn-item"><span class="darkmode_switchbutton" onclick="sco.switchDarkMode()" title="Day and night switching"><i class="solitude st-moon-clear-fill"></i></span></div><div class="console-btn-item" id="consoleHideAside"><span class="asideSwitch" onclick="sco.switchHideAside()" title="Sidebar display control"><i class="solitude st-side-bar-fill"></i></span></div></div><div class="console-mask" onclick="sco.hideConsole()"></div></div><!-- sidebar--><div id="sidebar" style="zoom: 1;"><div id="menu-mask" style="display: none;"></div><div id="sidebar-menus"><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Archives</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">4</div></a></div></div></div><span class="sidebar-menu-item-title">Function</span><div class="sidebar-menu-item"><span class="darkmode_switchbutton menu-child" onclick="sco.switchDarkMode()"><i class="solitude st-moon-clear-fill"></i><span>Display mode</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>Articals</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>Artical List</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>All tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>About</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>About</span></a></li></ul></div></div><span class="sidebar-menu-item-title">Tags</span><div class="card-widget card-tags card-archives card-webinfo card-allinfo"><div class="card-tag-cloud"><a href="/tags/Distrubute-System/">Distrubute System<sup>2</sup></a><a href="/tags/System-Administration/">System Administration<sup>6</sup></a><a href="/tags/AI/">AI<sup>1</sup></a><a href="/tags/Search-Infra/">Search Infra<sup>1</sup></a></div></div></div></div><!-- keyboard--><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav class="show" id="nav"><div id="nav-group"><div id="blog_name"><a id="site-name" href="/" title="Back to home"><span class="title">Ankai Liang / ex-Googler / ByteDancer</span></a></div><div id="page-name-mask"><div id="page-name"><a id="page-name-text" onclick="sco.toTop()">afewmore</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><span>Home</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>Articals</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="solitude  st-folder-fill"></i><span>Artical List</span></a></li><li><a class="site-page child" href="/tags/"><i class="solitude  st-price-tag-fill"></i><span>All tags</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span>About</span></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="solitude  st-contacts-fill"></i><span>About</span></a></li></ul></div></div></div><div id="nav-left"></div><div id="nav-right"><div class="nav-button" id="nav-totop" onclick="sco.toTop()"><a class="totopbtn"><i class="solitude st-arrow-up-line"></i><span id="percent">0</span></a></div><div id="toggle-menu"><a class="site-page"><i class="solitude st-menu-line"></i></a></div></div></div></nav><div class="coverdiv" id="coverdiv"><img class="nolazyload" id="post-cover" src="/img/default4.png" alt="afewmore"></div><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original" title="This article is a Original article, pay attention to the copyright.">Original</a><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/System-Administration/"><span class="tags-name tags-punctuation">System Administration</span></a></div></div></div></div><h1 class="post-title">afewmore</h1><div id="post-meta"><div class="meta-secondline"></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><div class="post-ai"><div class="ai-title"><div class="ai-title-left"><i class="ai-title-icon solitude st-robot-fill"></i><div class="ai-title-text">文章摘要</div></div><div class="ai-tag" id="ai-tag">GPT 4</div></div><div class="ai-explanation" style="display: block;"></div><div class="ai-suggestions"></div><div class="ai-bottom"><div class="ai-tips"></div><a class="ai-report" title="投诉" target="_blank" rel="noopener" href="https://efu.me/">投诉</a></div></div><article class="post-content" id="article-container"><h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><ul>
<li>link: <a target="_blank" rel="noopener" href="http://www.cs.stevens.edu/~jschauma/615/s17-hw6.html">http://www.cs.stevens.edu/~jschauma/615/s17-hw6.html</a></li>
</ul>
<h2 id="Objective"><a href="#Objective" class="headerlink" title="Objective:"></a>Objective:</h2><p>The objective of this assignment is for you to write a simple system tool to perform a realistic sysadmin task using the EC2 environment. In doing so, you will practice the core principles of writing scalable system tools as discussed in class.</p>
<p>You will also learn to implement a program from a high-level specification. In so doing, you will practice the detection of hidden requirements and decision making in the face of ambiguity.</p>
<p>This assignment is worth 50 points.</p>
<p>Summary:</p>
<p>Implement the afewmore command as specified in this manual page.</p>
<p>Your program will behave exactly as outlined in that manual page, with no additional output or functionality.</p>
<p>Target platform:</p>
<p>The tool you write will be executed (and graded) on an Ubuntu instance ami-6de0dd04 with the ‘awscli’ package installed via ‘sudo apt-get install awscli’. If your tool does not work in this environment, you will not get any points. See also: general homework guidelines.</p>
<p>Programming language</p>
<p>You are free to choose any programming language you like to implement this tool. Obviously, the program needs to be executed&#x2F;run on the Ubuntu instance, and must not require the additional installation of any tools, libraries etc. besides what is already installed there.</p>
<p>Program behaviour</p>
<p>Your program will not require any modification of the environment (ie, you can assume the user has his&#x2F;her environment set up for EC2), and exection of the program will be exactly as outlined in the manual page afewmore(1).</p>
<p>Your program will be robust. That is, it will handle error conditions and erroneous input in a graceful manner. Make sure to consider all the edge cases!</p>
<hr>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><h1 id="afewmore"><a href="#afewmore" class="headerlink" title="afewmore"></a>afewmore</h1><p>This is a task of CS615 in Stevens Institute of Technology.</p>
<p>Author</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/efitzpa1">Eric Fitzpatrick</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AnkaiLiang">Ankai Liang</a></li>
</ul>
<h1 id="Program-description"><a href="#Program-description" class="headerlink" title="Program description"></a>Program description</h1><p>For this homework assignment, our group used Bash as our programming language of choice. Bash allowed for us to easily interface with common shell commands and the AWS CLI tool. Since Bash has such low overhead, it also allows us to have competitive performance and write functionality compactly and directly.</p>
<h1 id="Challenges-faced"><a href="#Challenges-faced" class="headerlink" title="Challenges faced"></a>Challenges faced</h1><p>The main challenge that our group faced is how to determine when a newly created EC2 instance is ready to ssh into. We got around this challenge by using sleep(1) commands to first wait for the instance state to change to ‘Running’ and then attempting to ssh into the instance a few times after small time intervals.</p>
<h2 id="Manual"><a href="#Manual" class="headerlink" title="Manual"></a>Manual</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">AFEWMORE(1)		  BSD General Commands Manual		   AFEWMORE(1)</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">     afewmore -- duplicate EC2 instances with their data directory</span><br><span class="line"></span><br><span class="line">SYNOPSIS</span><br><span class="line">     afewmore [-hv] [-d dir] [-n num] instance</span><br><span class="line"></span><br><span class="line">DESCRIPTION</span><br><span class="line">     The afewmore tool can be used to duplicate a given EC2 instance.  When</span><br><span class="line">     doing so, it creates multiple new instances and populates their data</span><br><span class="line">     directory by copying the data from the original.</span><br><span class="line"></span><br><span class="line">OPTIONS</span><br><span class="line">     The source instance is specified via the mandatory argument to afewmore.</span><br><span class="line">     In addition, the following command-line options are supported:</span><br><span class="line"></span><br><span class="line">     -d dir   Copy the contents of this data directory from the orignal source</span><br><span class="line">	      instance to all the new instances.  If not specified, defaults</span><br><span class="line">	      to /data.</span><br><span class="line"></span><br><span class="line">     -h       Print a usage statement and exit.</span><br><span class="line"></span><br><span class="line">     -n num   Create this many new instances.  If not specified, defaults to</span><br><span class="line">	      10.</span><br><span class="line"></span><br><span class="line">     -v       Be verbose.</span><br><span class="line"></span><br><span class="line">DETAILS</span><br><span class="line">     Frequently, it is necessary to duplicate a given server&#x27;s configuration</span><br><span class="line">     or setup.	While configuration management and service orchestration sys-</span><br><span class="line">     tems may be able to perform this task, the afewmore tool allows for a</span><br><span class="line">     trivial initial bootstrapping that only concerns itself with data dupli-</span><br><span class="line">     cation, not host configuration.</span><br><span class="line"></span><br><span class="line">     Upon invocation, afewmore will identify the type of EC2 instance in ques-</span><br><span class="line">     tion and launch the requested number of duplicates.  It will then copy</span><br><span class="line">     the contents of the given directory from the source instance to all of</span><br><span class="line">     the newly created instances.</span><br><span class="line"></span><br><span class="line">OUTPUT</span><br><span class="line">     By default, afewmore prints the instance IDs of the newly created EC2</span><br><span class="line">     instances as the only output.  Unless an error occurs, no other output is</span><br><span class="line">     generated.</span><br><span class="line"></span><br><span class="line">     If the -v flag is given, afewmore may print meaningful diagnostic mes-</span><br><span class="line">     sages as it progresses to stdout.</span><br><span class="line"></span><br><span class="line">     Any errors encountered cause a meaningful error message to be printed to</span><br><span class="line">     STDERR.</span><br><span class="line"></span><br><span class="line">ENVIRONMENT</span><br><span class="line">     The afewmore tool is suitable to be used by any user and does not have</span><br><span class="line">     any user-specific settings or credentials hard coded.</span><br><span class="line"></span><br><span class="line">     afewmore assumes that the user has set up their environment for general</span><br><span class="line">     use with the EC2 tools.  That is, it will not set or modify any environ-</span><br><span class="line">     ment variables.</span><br><span class="line"></span><br><span class="line">     afewmore also assumes that the user has set up their ~/.ssh/config file</span><br><span class="line">     to access instances in EC2 via ssh(1) without any additional settings.</span><br><span class="line"></span><br><span class="line">EXIT STATUS</span><br><span class="line">     The afewmore will exit with a return status of 0 under normal circum-</span><br><span class="line">     stances.  If an error occurred, afewmore will exit with a value &gt;0.</span><br><span class="line"></span><br><span class="line">EXAMPLES</span><br><span class="line">     The following examples illustrate common usage of this tool.</span><br><span class="line"></span><br><span class="line">     To create ten more instances of the EC2 instance i-0a1b2c3d4f and copy</span><br><span class="line">     the contents of the &#x27;/data&#x27; directory from that instance:</span><br><span class="line"></span><br><span class="line">	   $ afewmore i-0a1b2c3d4f</span><br><span class="line">	   i-1a1b2c3d4f</span><br><span class="line">	   i-2a1b2c3d4f</span><br><span class="line">	   i-3a1b2c3d4f</span><br><span class="line">	   i-4a1b2c3d4f</span><br><span class="line">	   i-5a1b2c3d4f</span><br><span class="line">	   i-6a1b2c3d4f</span><br><span class="line">	   i-7a1b2c3d4f</span><br><span class="line">	   i-8a1b2c3d4f</span><br><span class="line">	   i-9a1b2c3d4f</span><br><span class="line">	   i-0b1b2c3d4f</span><br><span class="line">	   $ echo $?</span><br><span class="line">	   0</span><br><span class="line">	   $</span><br><span class="line"></span><br><span class="line">     To create just one more instance and copy the contents of the directory</span><br><span class="line">     &#x27;/usr/local/share&#x27;:</span><br><span class="line"></span><br><span class="line">	   $ afewmore -d /usr/local/share -n 1 i-0a1b2c3d4f</span><br><span class="line">	   i-1a1b2c3d4f</span><br><span class="line">	   $</span><br><span class="line"></span><br><span class="line">SEE ALSO</span><br><span class="line">     aws help, ssh(1), tar(1), rsync(1)</span><br><span class="line"></span><br><span class="line">HISTORY</span><br><span class="line">     afewmore was originally assigned by Jan Schaumann</span><br><span class="line">     &lt;jschauma@cs.stevens.edu&gt; as a homework assignment for the class &quot;Aspects</span><br><span class="line">     of System Administration&quot; at Stevens Institute of Technology in the</span><br><span class="line">     Spring of 2017.</span><br><span class="line"></span><br><span class="line">BSD				April 09, 2017				   BSD</span><br></pre></td></tr></table></figure>

<h2 id="The-commentary"><a href="#The-commentary" class="headerlink" title="The commentary"></a>The commentary</h2><h3 id="Ankai-Liang"><a href="#Ankai-Liang" class="headerlink" title="Ankai Liang"></a>Ankai Liang</h3><p>I decide to use shell script to finish this task.</p>
<ol>
<li><p>At the beginning, I look for the arguments which inputted by user.<br>I found two way, one is manually dealing with them. It requires users to input arguments with explicit position. The other way is using <code>getopts</code>, a useful tool which can handle the short options.<br><a target="_blank" rel="noopener" href="http://wiki.bash-hackers.org/howto/getopts_tutorial">Tutorial</a><br>After testing, I found that if -d is missing an argument, it will instead of taking the next option as the parameter. So I added a check in each options which need value.</p>
</li>
<li><p>Then I need to grab the information of target instance by a given instance-id.<br>I learned how to write a funtion in Shell Script. When I test the result shell function return, I found <code>$?</code> only return the numeric result, and the variable without <code>local</code> declaration would domain global, a good choice to record the function result.<br>About the parameter passing, if I use variable to transfer the json data, it will lose the line feeds. So I use the temp file to store the json data.<br>By the way, using ‘&amp;’ to make <code>echo command</code> running in background in funtion and using ‘a&#x3D;<code>func args</code>‘ outside is also a good way to implement funtion return. But in this way, it can’t exit entire script in function when meet error. Maybe the main shell create a sub-shell environment to run sub-command.<br>Tricky point, sometimes the response from aws contains some null data in some attributes. We should filter them by ‘grep “^$”‘</p>
</li>
<li><p>Next I try to ensure what is UserName when ssh to remote server. Create a table, acquire image-Description, and use awk to match UserName. When use awk to do regular expression searching, I have to transfer the shell variables into awk.<a target="_blank" rel="noopener" href="https://www.gnu.org/software/gawk/manual/gawk.html#Using-Shell-Variables">Tutorial</a></p>
</li>
<li><p>I want to check whether shell sucessfully ssh to the Target server. But I noticed when I offer the wrong username, cli will go into interface and ask for password. If I want to automaticlly deal with the interface, I need install <code>expect</code>, that’s unallowed. I don’t have a better way to solve it.</p>
</li>
<li><p>When trasfer the data between two instance, my test remote instance is NetBSD without rsync, I decided transfer the data by <code>scp</code>.</p>
</li>
<li><p>Because setting up instance need some time. so I have to wait a few seconds then execute the copy mission.</p>
</li>
<li><p>“Host key verification failed.” I fail to use <code>scp</code> transfer data from remote instance to another remote one. I realized scp can’t do that between two remote nodes. I need to copy one node’s rsa public key to the other, then use ssh into one remote to do that transmission.<br>After communication with classmates, I knew that <code>scp</code> has a option ‘-3’, which can transfer data between two remote instance via the local instance. According the principle of least astonishment, I think using <code>scp -3</code> without the change of <code>authorized_keys</code> file is the better solution.</p>
</li>
<li><p>Deal with the directory path. Before using <code>scp</code>, I have to make sure the directory’s parent path exists. Use pattern matching to adjust <code>$&#123;path&#125;</code> and <code>mkdir -p</code> to create in new instance.</p>
</li>
<li><p>Implement all basic function!</p>
</li>
<li><p>When testing create instance with other images, I found some of OS login user accounts don’t have the authority to create new directory or files in some specific place. So I shoud chang the target directory authority to allow ssh write and execute.</p>
</li>
</ol>
<h3 id="Eric-Fitzpatrick"><a href="#Eric-Fitzpatrick" class="headerlink" title="Eric Fitzpatrick"></a>Eric Fitzpatrick</h3><p>Ankai and I chose to both develop our own independent versions of the ‘afewmore’ program and then collaborate to merge the best parts of our implementations together. I also used Bash so this process was straightforward. We took very similar approaches so I chose to refine the version on Ankai’s GitHub repository to match up to mine and use as our submission. My main contributions to his version was increasing the error handling capabilities of the program, increasing the verbosity of the usage statement (included flag information), and modifying the script to use the mktemp(1) function instead of an in-directory temp.txt file which could have potentially deleted or modified a user’s temp.txt file unintentionally. I also added a trap(1) statement to delete this temporary file upon a SIGINT signal (control+c).</p>
<hr>
<h1 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">catalog=<span class="string">&quot;/data&quot;</span></span><br><span class="line">num=10</span><br><span class="line">verbose=<span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">cleanup</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">log</span> <span class="string">&quot;Cleaning up temporary file&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> -f <span class="variable">$tmp</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">log</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$verbose</span>&quot;</span> = <span class="string">&quot;true&quot;</span> ];</span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$@</span> </span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">iferr</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> [ $? != 0 ];</span><br><span class="line">	<span class="keyword">then</span> </span><br><span class="line">		<span class="built_in">echo</span> <span class="variable">$@</span> &gt;&amp;2</span><br><span class="line">		<span class="built_in">exit</span> 1;</span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">usage</span></span>() </span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">echo</span> -e <span class="string">&quot;Usage: afewmore [-hv] [-d dir] [-n num] instance\n\n  -d dir  Copy the contents of this data directory from the original source\n          instance to all new instances. If not specified, defaults\n          to /data.\n\n  -h      Print a usage statement and exit.\n\n  -n num  Create this many new instances. If not specified, defaults to\n          10.\n\n  -v      Be verbose.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">getInfo</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	((cat <span class="variable">$tmp</span> | grep &quot;\&quot;<span class="variable">$1</span>\&quot;&quot;) || (echo &quot;Fail to get the <span class="variable">$1</span> info.&quot; &gt;&amp;<span class="number">2</span>; exit <span class="number">1</span>;))\</span><br><span class="line">	 | <span class="built_in">tr</span> <span class="string">&quot;:\&quot;,&quot;</span> <span class="string">&quot; &quot;</span>  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | grep -v <span class="string">&quot;null&quot;</span> | grep -v <span class="string">&quot;^$&quot;</span></span><br><span class="line"><span class="comment">#	delete the null line</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">getAllInfo</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">	InstanceId=<span class="variable">$1</span></span><br><span class="line">	aws ec2 describe-instances --output json --filters <span class="string">&quot;Name=instance-id,Values=<span class="variable">$&#123;InstanceId&#125;</span>&quot;</span> &gt; <span class="variable">$tmp</span></span><br><span class="line">	PublicDnsName=$(getInfo PublicDnsName)</span><br><span class="line">	ImageId=$(getInfo ImageId)</span><br><span class="line">	InstanceType=$(getInfo InstanceType)</span><br><span class="line">	KeyName=$(getInfo KeyName)</span><br><span class="line">	GroupName=$(getInfo GroupName)</span><br><span class="line">	AvailabilityZone=$(getInfo AvailabilityZone)</span><br><span class="line">	PublicDnsName=$(getInfo PublicDnsName)</span><br><span class="line">	iferr <span class="string">&quot;Fail to get the info for <span class="variable">$&#123;InstanceId&#125;</span>. Please check instance-id and its state.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">getopts</span> <span class="string">&quot;:d:n:hv&quot;</span> arg; </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">case</span> <span class="variable">$&#123;arg&#125;</span> <span class="keyword">in</span></span><br><span class="line">		h)</span><br><span class="line">			usage</span><br><span class="line">			<span class="built_in">exit</span> 0</span><br><span class="line">			;;</span><br><span class="line">		d)</span><br><span class="line">			catalog=<span class="variable">$&#123;OPTARG&#125;</span></span><br><span class="line">			<span class="keyword">if</span> ! [[ <span class="variable">$catalog</span> =~ ^/.*$ ]];</span><br><span class="line">			<span class="keyword">then</span></span><br><span class="line">				<span class="built_in">echo</span> <span class="string">&quot;-d&#x27;s argument is not a valid Unix style path&quot;</span> &gt;&amp;2</span><br><span class="line">				usage</span><br><span class="line">				<span class="built_in">exit</span> 1;</span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			;;</span><br><span class="line">		n)	</span><br><span class="line">			<span class="keyword">if</span> [[ <span class="variable">$OPTARG</span> =~ ^[0-9]+$ ]]</span><br><span class="line">			<span class="keyword">then</span></span><br><span class="line">			    <span class="keyword">if</span> [ <span class="variable">$OPTARG</span> -gt 0 ]</span><br><span class="line">			    <span class="keyword">then</span></span><br><span class="line">				num=<span class="variable">$&#123;OPTARG&#125;</span></span><br><span class="line">			    <span class="keyword">else</span></span><br><span class="line">				<span class="built_in">echo</span> <span class="string">&quot;-n&#x27;s argument must be greater than 0.&quot;</span> &gt;&amp;2</span><br><span class="line">				<span class="built_in">exit</span> 1;</span><br><span class="line">			    <span class="keyword">fi</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="built_in">echo</span> <span class="string">&quot;-n&#x27;s argument is not a number.&quot;</span> &gt;&amp;2</span><br><span class="line">				usage</span><br><span class="line">				<span class="built_in">exit</span> 1;</span><br><span class="line">			<span class="keyword">fi</span></span><br><span class="line">			;;</span><br><span class="line">		v)</span><br><span class="line">			verbose=<span class="string">&quot;true&quot;</span></span><br><span class="line">			;;</span><br><span class="line">		\?)</span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;Unknown argument: -<span class="variable">$OPTARG</span>&quot;</span> &gt;&amp;2</span><br><span class="line">			usage</span><br><span class="line">			<span class="built_in">exit</span> 1</span><br><span class="line">			;;</span><br><span class="line">		:)</span><br><span class="line">      		<span class="built_in">echo</span> <span class="string">&quot;Option -<span class="variable">$OPTARG</span> requires an argument.&quot;</span> &gt;&amp;2</span><br><span class="line">      		usage</span><br><span class="line">     		<span class="built_in">exit</span> 1</span><br><span class="line">     		;;</span><br><span class="line">	<span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">shift</span> $((OPTIND-<span class="number">1</span>)) <span class="comment"># shift the instance id arguments to $1</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$1</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Requires an instance id to point out which instance will be replicated.&quot;</span> &gt;&amp;2</span><br><span class="line">	usage</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Arguments format is correct.&quot;</span> </span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Tring to acquire target instance&#x27;s info...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get the info for origin instance</span></span><br><span class="line"></span><br><span class="line">targetId=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span> ! [[ <span class="variable">$targetId</span> =~ ^i-[a-z0-9]+$ ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Invalid instance ID &#x27;<span class="variable">$targetId</span>&#x27; provided.&quot;</span> &gt;&amp;2</span><br><span class="line">    usage</span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">tmp=$(<span class="built_in">mktemp</span>)</span><br><span class="line"><span class="built_in">trap</span> cleanup SIGINT</span><br><span class="line">getAllInfo <span class="variable">$targetId</span></span><br><span class="line">targetPublicDns=<span class="variable">$&#123;PublicDnsName&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;done&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Target instance info: InstanceId=<span class="variable">$&#123;InstanceId&#125;</span>, PublicDnsName=<span class="variable">$&#123;PublicDnsName&#125;</span>, InstanceType=<span class="variable">$&#123;InstanceType&#125;</span>,\</span></span><br><span class="line"><span class="string"> ImageId=<span class="variable">$&#123;ImageId&#125;</span>, KeyName=<span class="variable">$&#123;KeyName&#125;</span>, GroupName=<span class="variable">$&#123;GroupName&#125;</span>, AvailabilityZone=<span class="variable">$&#123;AvailabilityZone&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Tring to ssh to target instance...&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">## get the username according to image-id</span></span><br><span class="line"></span><br><span class="line">aws ec2 describe-images --output json --filters <span class="string">&quot;Name=image-id, Values=<span class="variable">$&#123;ImageId&#125;</span>&quot;</span> &gt; <span class="variable">$tmp</span></span><br><span class="line">ImageName=$(getInfo Name)</span><br><span class="line">username=$(<span class="built_in">cat</span> UsernameTable | awk -F <span class="string">&quot;:&quot;</span> -v pat=<span class="string">&quot;<span class="variable">$&#123;ImageName&#125;</span>&quot;</span> <span class="string">&#x27;pat ~ $1 &#123; print $2 &#125;&#x27;</span> | <span class="built_in">head</span> -1)</span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$&#123;username&#125;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	username=<span class="string">&quot;root&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## check can we log into target instance and the directory is exist</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span> :;</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;successful ssh to the target instance&quot;</span></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;username=<span class="variable">$&#123;username&#125;</span>, ImageName=<span class="variable">$&#123;ImageName&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;Fail to ssh to the target instance&quot;</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ssh -o StrictHostKeyChecking=no <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span> <span class="built_in">test</span> -e <span class="variable">$&#123;catalog&#125;</span>;</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;<span class="variable">$&#123;catalog&#125;</span> exists on instance &#x27;<span class="variable">$targetId</span>&#x27;&quot;</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;catalog&#125;</span> does not exist on instance &#x27;<span class="variable">$targetId</span>&#x27;, please check the directory path&quot;</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># create $&#123;num&#125; new instance. </span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Trying to create <span class="variable">$&#123;num&#125;</span> new instances...&quot;</span></span><br><span class="line"></span><br><span class="line">aws ec2 run-instances --image-id <span class="variable">$&#123;ImageId&#125;</span> --count <span class="variable">$&#123;num&#125;</span> --instance-type\</span><br><span class="line"> <span class="variable">$&#123;InstanceType&#125;</span> --key-name <span class="variable">$&#123;KeyName&#125;</span> --security-groups <span class="variable">$&#123;GroupName&#125;</span> --placement AvailabilityZone=<span class="variable">$&#123;AvailabilityZone&#125;</span> &gt; <span class="variable">$tmp</span></span><br><span class="line">iferr <span class="string">&quot;Fail to create new instances, plase check awscli configuration and network&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;done&quot;</span></span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Waiting for instances pending...&quot;</span></span><br><span class="line">getInfo InstanceId &gt; listInstanceId.txt</span><br><span class="line"><span class="built_in">sleep</span> 100s</span><br><span class="line"></span><br><span class="line"><span class="comment">## Deal with each new Instance</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> $(<span class="built_in">cat</span> listInstanceId.txt)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	aws ec2 describe-instances --output json --filters <span class="string">&quot;Name=instance-id,Values=<span class="variable">$&#123;line&#125;</span>&quot;</span> &gt; <span class="variable">$tmp</span></span><br><span class="line">	state=$(getInfo Name)</span><br><span class="line">	i=0;</span><br><span class="line">	<span class="keyword">while</span> [ <span class="string">&quot;<span class="variable">$&#123;state&#125;</span>&quot;</span> != <span class="string">&quot;running&quot;</span> ];</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		i=$(( <span class="variable">$i</span> + <span class="number">1</span> ))</span><br><span class="line">		<span class="built_in">sleep</span> 5s</span><br><span class="line">		aws ec2 describe-instances --output json --filters <span class="string">&quot;Name=instance-id,Values=<span class="variable">$&#123;line&#125;</span>&quot;</span> &gt; <span class="variable">$tmp</span></span><br><span class="line">		state=$(getInfo Name) <span class="comment"># loop until state = running</span></span><br><span class="line">		<span class="keyword">if</span> [ <span class="variable">$&#123;i&#125;</span> -gt 10 ]</span><br><span class="line">		<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;Overtime, fail to get PublicDnsName for instance <span class="variable">$&#123;line&#125;</span>&quot;</span> &gt;&amp;2</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	</span><br><span class="line">	newPublicDnsName=$(getInfo PublicDnsName)</span><br><span class="line">	iferr <span class="string">&quot;Fail to get newPublicDnsName for instance <span class="variable">$&#123;line&#125;</span>&quot;</span></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;newPublicDnsName=<span class="variable">$&#123;newPublicDnsName&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;Testing ssh to new instance <span class="variable">$&#123;line&#125;</span>...&quot;</span></span><br><span class="line">	i=0;</span><br><span class="line">	ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span> :</span><br><span class="line">	<span class="keyword">while</span> [ $? != 0 ];</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		i=$(( <span class="variable">$i</span> + <span class="number">1</span> ))</span><br><span class="line">		<span class="keyword">if</span> [ <span class="variable">$&#123;i&#125;</span> -gt 15 ]</span><br><span class="line">		<span class="keyword">then</span></span><br><span class="line">			<span class="built_in">echo</span> <span class="string">&quot;Fail ssh to new instance <span class="variable">$&#123;line&#125;</span>&quot;</span> &gt;&amp;2</span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		<span class="built_in">sleep</span> 5s</span><br><span class="line">		ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span> :</span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;done&quot;</span> </span><br><span class="line"></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;Prepare the directory on new instance <span class="variable">$&#123;line&#125;</span>&quot;</span></span><br><span class="line">	newcatalog=<span class="string">&quot;<span class="variable">$&#123;catalog%/?*&#125;</span>&quot;</span></span><br><span class="line">	ssh -o StrictHostKeyChecking=no -o LogLevel=quiet <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span> <span class="string">&quot;(test -e <span class="variable">$&#123;newcatalog:=&quot;/&quot;&#125;</span> || sudo mkdir -p <span class="variable">$&#123;newcatalog&#125;</span>) &amp;&amp; ([ -w <span class="variable">$&#123;newcatalog&#125;</span> ] &amp;&amp; [ -x <span class="variable">$&#123;newcatalog&#125;</span> ] || sudo chmod a+wx <span class="variable">$&#123;newcatalog&#125;</span>)&quot;</span></span><br><span class="line">	iferr <span class="string">&quot;Fail to create directory path on instance <span class="variable">$&#123;line&#125;</span>&quot;</span></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;Ready. newcatalog=<span class="variable">$newcatalog</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;Running scp -3 from <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span>:<span class="variable">$&#123;catalog&#125;</span> to <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span>:<span class="variable">$&#123;newcatalog&#125;</span>...&quot;</span></span><br><span class="line">	scp -r -q -p -o StrictHostKeyChecking=no -o LogLevel=quiet -3 <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;targetPublicDns&#125;</span>:<span class="variable">$&#123;catalog&#125;</span> <span class="variable">$&#123;username&#125;</span>@<span class="variable">$&#123;newPublicDnsName&#125;</span>:<span class="variable">$&#123;newcatalog&#125;</span></span><br><span class="line">	iferr <span class="string">&quot;Fail to copy directory content form <span class="variable">$&#123;targetId&#125;</span> to <span class="variable">$&#123;line&#125;</span>&quot;</span></span><br><span class="line">	<span class="built_in">log</span> <span class="string">&quot;done.&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> listInstanceId.txt</span><br><span class="line"><span class="built_in">log</span> <span class="string">&quot;Success.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> <span class="variable">$tmp</span></span><br><span class="line"><span class="built_in">rm</span> listInstanceId.txt</span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author_group"><a class="post-copyright__author_img" href="/about/"><img class="post-copyright__author_img_front" src="/img/pwa/favicon.png"></a><div class="post-copyright__author_name">Ankai Liang's Blog</div><div class="post-copyright__author_desc">Strong but not aggressive, weak but not feeble.</div></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div id="quit-box" onclick="RemoveRewardMask()"></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">This piece of writing is an original article, utilizing the<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a>Agreement. For complete reproduction, please acknowledge the source as Courtesy of<a href="/">Ankai Liang's Blog</a></span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/System-Administration/"><span class="tags-punctuation"></span>System Administration<span class="tagsPageCount">6</span></a></div></div></div><nav class="needEndHide pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2017/08/17/Text-processing-in-Linux/"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Text-processing</div></div></a></div><div class="next-post pull-right"><a href="/2017/08/16/tcpdump-1-DNS/"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">tcpdump(1) DNS</div></div></a></div></nav><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="solitude st-chat-fill"></i><span> Comment</span><span></span></div></div><div class="comment-wrap"><div id="comment"></div><script>async function initComment() {
    const isLazyLoad = !true;
    let walineInitFunction = window.walineFn || null;

    async function initWaline(Fn) {
        const walineOptions = {
            el: '#comment',
            serverURL: 'https://waline-comment-b9nz6bbxt-ankailiangs-projects.vercel.app/',
            pageview: !isLazyLoad,
            dark: 'html[data-theme="dark"]',
            path: window.location.pathname,
            comment: !isLazyLoad,
            ...null
        };
        const walineInstance = Fn(walineOptions);

        utils.addGlobalFn('pjax', () => walineInstance.destroy(), 'destroyWaline');
    }

    async function loadWalineCSSAndJS() {
        if (!walineInitFunction) {
            await getCSS('https://cdn.staticfile.net/waline/3.1.3/waline.min.css');
            const {init} = await import('https://cdn.staticfile.net/waline/3.1.3/waline.min.js');
            walineInitFunction = init || Waline.init;
            window.walineFn = walineInitFunction;
        }
        initWaline(walineInitFunction);
    }

    if (isLazyLoad) {
        utils.loadComment(document.getElementById('comment'),loadWalineCSSAndJS);
    } else {
        await loadWalineCSSAndJS();
    }

    if (GLOBAL_CONFIG.lightbox) {
        utils.lightbox(document.querySelectorAll('#comment .wl-content img:not(.wl-emoji)'));
    }

    sco.owoBig();
}</script></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><div class="author-info__top-group"><div class="author-info__sayhi" id="author-info__sayhi" onclick="sco.changeSayHelloText()">sayhello.morning</div></div></div><div class="avatar-img-group"><img class="avatar-img" alt="Avatar" src="/img/avatar.png"><div class="avatar-sticker"><img class="avatar-sticker-img" src="https://7.isyangs.cn/34/65f2e4e0423cc-34.png" alt="Mood sticker"></div></div><div class="author-info__description_group"><div class="author-info__description">Share my <b>passion</b> for programming, <b>aspiration</b> for a better life, and <b>journey</b> of exploring the ocean of knowledge.</div><div class="author-info__description2"></div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about/"><div class="author-info__name">Ankai Liang</div><div class="author-info__desc">Strong but not aggressive, weak but not feeble.</div></a><div class="card-info-social-icons is-center"><a class="social-icon" target="_blank" rel="noopener" href="https://github.com/ankaiLiang" title="Github"><i class="solitude  st-github-line"></i></a><a class="social-icon" target="_blank" rel="noopener" href="https://www.instagram.com/ankai_liang/" title="Instagram"><i class="solitude  st-image-fill"></i></a><a class="social-icon" target="_blank" rel="noopener" href="https://www.linkedin.com/in/ankai-liang-a774b3119?trk=hp-identity-name" title="LinkedIn"><i class="solitude  st-contacts-fill"></i></a><a class="social-icon" target="_blank" rel="noopener" href="https://www.facebook.com/lakeandgod" title="Facebook"><i class="solitude  st-contacts-fill"></i></a><a class="social-icon" target="_blank" rel="noopener" href="http://weibo.com/1783077873/profile?rightmod=1&amp;wvr=6&amp;mod=personnumber" title="weibo"><i class="solitude  st-contacts-fill"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="solitude st-menu-line"></i><span>Table of contents</span></div><div class="toc-content" id="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Description"><span class="toc-text">Description</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Objective"><span class="toc-text">Objective:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Content"><span class="toc-text">Content</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#afewmore"><span class="toc-text">afewmore</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Program-description"><span class="toc-text">Program description</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenges-faced"><span class="toc-text">Challenges faced</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Manual"><span class="toc-text">Manual</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-commentary"><span class="toc-text">The commentary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ankai-Liang"><span class="toc-text">Ankai Liang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Eric-Fitzpatrick"><span class="toc-text">Eric Fitzpatrick</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Code"><span class="toc-text">Code</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="solitude st-map-line"></i><span>New posts</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/08/17/Semi-Structured-Search/" title="Semi-Structured Search"><img alt="Semi-Structured Search" src="/img/default4.png"></a><div class="content"><a class="title" href="/2023/08/17/Semi-Structured-Search/" title="Semi-Structured Search">Semi-Structured Search</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2017/08/17/DHT-REMOTE/" title="DHT-REMOTE"><img alt="DHT-REMOTE" src="/img/default3.png"></a><div class="content"><a class="title" href="/2017/08/17/DHT-REMOTE/" title="DHT-REMOTE">DHT-REMOTE</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2017/08/17/Page-Rank-Hadoop/" title="Page Rank - Hadoop"><img alt="Page Rank - Hadoop" src="/img/default3.png"></a><div class="content"><a class="title" href="/2017/08/17/Page-Rank-Hadoop/" title="Page Rank - Hadoop">Page Rank - Hadoop</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2017/08/17/RushHour/" title="RushHour"><img alt="RushHour" src="/img/default5.png"></a><div class="content"><a class="title" href="/2017/08/17/RushHour/" title="RushHour">RushHour</a></div></div><div class="aside-list-item"><a class="thumbnail" href="/2017/08/17/Text-processing-in-Linux/" title="Text-processing"><img alt="Text-processing" src="/img/default5.png"></a><div class="content"><a class="title" href="/2017/08/17/Text-processing-in-Linux/" title="Text-processing">Text-processing</a></div></div></div></div></div></div></main><footer id="footer"><div id="st-footer-bar"><div class="footer-logo"><span class="solitude">Ankai Liang / ex-Googler / ByteDancer</span></div><div class="footer-bar-description">Article from Ankai Liang's Blog - Strong but not aggressive, weak but not feeble.</div><a class="footer-bar-link" href="/">Learn more</a></div><div id="footer_deal"><div class="nolazyload footer_mini_logo" id="footer_mini_logo" title="Back to top" onclick="sco.toTop()"><img src="/img/pwa/favicon.png" alt="Back to top"></div></div><div id="st-footer"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div class="copyright">© 2023 - 2024 By&nbsp;<a class="footer-bar-link" href="/">Ankai Liang</a></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/valor-x/hexo-theme-solitude" title="主题">主题</a><a class="footer-bar-link cc" href="/null" aria-label="copyright"><i class="solitude st-copyright-line"></i><i class="solitude st-creative-commons-by-line"></i><i class="solitude st-creative-commons-nc-line"></i><i class="solitude st-creative-commons-nd-line"></i></a></div></div></div></footer></div><!-- inject body--><div><script src="/js/main.js?v=1.7.8"></script><script src="/js/utils.js?v=1.7.8"></script><script src="/js/third_party/universe.min.js?v=1.7.8"></script><script>dark()
</script><script src="https://cdn.staticfile.net/pjax/0.2.8/pjax.min.js"></script><script src="https://cdn.staticfile.net/node-snackbar/0.1.16/snackbar.min.js"></script><script src="/js/third_party/efu_ai.min.js?v=1.7.8"></script><script src="https://cdn.staticfile.net/pace/1.2.4/pace.min.js"></script></div><div id="js-pjax"><script id="config-diff">var PAGE_CONFIG = {
    is_post: true,
    is_page: false,
    is_home: false,
    page: 'post',
    toc: true,
    comment: true,
}
</script></div><!-- newest comment--><!-- pjax--><script>let pjaxSelectors = [
    'title',
    '#body-wrap',
    '#site-config',
    'meta[name="description"]',
    '#js-pjax',
    'meta[property^="og:"]',
]

const pjax = new Pjax({
    elements: 'a:not([target="_blank"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
})

document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
})

document.addEventListener('pjax:complete', () => {
    window.refreshFn()
})

document.addEventListener('pjax:error', (e) => {
    if (e.request.status === 404) {
        pjax.loadUrl('/404.html')
    }
})</script><!-- theme--><script>initTheme = () => {
    let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const cachedMode = saveToLocal.get('theme');
    if (cachedMode === undefined) {
        const nowMode =
            isDarkMode ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', nowMode);
    } else {
        document.documentElement.setAttribute('data-theme', cachedMode);
    }
}
initTheme()</script><!-- google adsense--><!-- search--><!-- music--></body></html><script>const posts=["2023/08/17/Semi-Structured-Search/","2017/08/17/DHT-REMOTE/","2017/08/17/Page-Rank-Hadoop/","2017/08/17/RushHour/","2017/08/17/Text-processing-in-Linux/","2017/08/17/afewmore-A-tool-of-ec2-how-to-write-a-shell-tool/","2017/08/16/tcpdump-1-DNS/","2017/08/16/Using-Manages-packages-in-Linux/","2017/08/16/Using-the-AWS-CLI-to-set-instance/","2017/05/19/Install and Configure AWS Tools/"];function toRandomPost(){ pjax.loadUrl('/'+posts[Math.floor(Math.random()*posts.length)]); }</script>